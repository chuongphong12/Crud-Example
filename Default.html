<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head >
  <title></title>
  <!-- CDN code -->
  <!-- CSS -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <!-- Jquery -->
  <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
  <!-- JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head >
<body>
	<div class="container">
		<div class="row">
			<div class="col-sm-6">
				<h2>Paul's Training Company</h2>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-6">
				<table id="productTable" class="table table-bordered table-condensed table-striped">
					<thead>
						<tr>
                            <th>Edit</th>
						    <th>Product Name</th>
						    <th>Introduction Date</th>
						    <th>URL</th>
                            <th>Delete</th>
						</tr>
						<tr id = "loading">
							<th colspan = "5" align = "center"><img src = "giphy.gif"></th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-6">
				<button type="button" id="addButton" class="btn btn-primary" onclick="addClick();">
				  Add Product
				</button>
			</div>
		</div>
        <br />
		<div class="row">
			<div class="col-sm-6">
				<div class="panel panel-primary">
					<div class="panel-heading">
						Product Information
					</div>
					<div class="panel-body">
                        <input type="hidden" id="productid" value="0" />
						<div class="form-group">
							<label for="productname">Product Name</label>
							<input type="text" id="productname" class="form-control" />
						</div>
						<div class="form-group">
							<label for="introdate">Introduction Date</label>
							<input type="date" id="introdate" class="form-control" />
						</div>
						<div class="form-group">
							<label for="url">URL</label>
							<input type="url" id="url" class="form-control" />
						</div>
					</div>
					<div class="panel-footer">
						<div class="row">
							<div class="col-xs-12">
								<button type="button" id="updateButton" class="btn btn-primary" onclick="updateClick();">
								  Add
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		// Handle click event on Update button
        function updateClick() {
            // Build product object from inputs
            Product = new Object();
            Product.ProductName = $("#productname").val();
            Product.IntroductionDate = $("#introdate").val();
            Product.Url = $("#url").val();

            if ($("#updateButton").text().trim() == "Add") {
                //submit this JavaScript object(Product) to the Post method in your API
                productAdd(Product);
            }
            else {
                productUpdate(Product);
            }
		}

		// Handle click event on Add button
		function addClick() {
		    //clear the input fields so that they’re ready to add a new product
		    formClear();
		}
		function productList() {
			// Call Web API to get a list of Product
			$.ajax({
				url: '/crud/api/Product/get.json',
				type: 'GET',
				<!-- dataType: 'text', -->
				dataType: 'json',
				success: function (products) {
					productListSuccess(products);
					$('#loading').hide();
					//Announcement is the list of products declared in get.json if type of this ajax is text
					//Announcement is object if type of this ajax is json
					alert(products);
				},
				error: function (request, message, error) {
					handleException(request, message, error);
				}
			});
		}

		function productListSuccess(products) {
			// Iterate over the collection of data
			$.each(products, function (index, product) {
			// Add a row to the Product table
				productAddRow(product);
			});
		}

		function productAddRow(product) {
			// Check if <tbody> tag exists, add one if not
			if ($("#productTable tbody").length == 0) {
				$("#productTable").append("<tbody></tbody>");
			}
			// Append row to <table>
			$("#productTable tbody").append(productBuildTableRow(product));
		}

		function productBuildTableRow(product) {
			var ret =
				"<tr>" +
                "<td>" +
                    "<button type='button' " +
                    "onclick='productGet(this);' " +
                    "class='btn btn-default' " +
                    "data-id='" + product.ProductId + "'>" +
                    "<span class='glyphicon glyphicon-edit' />" +
                    "</button>" +
                "</td >" +
				"<td>" + product.ProductName + "</td>" +
				"<td>" + product.IntroductionDate + "</td>" +
                "<td>" + product.Url + "</td>" +
                "<td>" +
                    "<button type='button' " +
                    "onclick='productDelete(this);' " +
                    "class='btn btn-default' " +
                    "data-id='" + product.ProductId + "'>" +
                    "<span class='glyphicon glyphicon-remove' />" +
                    "</button>" +
                "</td>" +
				"</tr>";
			return ret;
		}

		function handleException(request, message, error) {
			var msg = "";
			msg += "Code: " + request.status + "\n";
			msg += "Text: " + request.statusText + "\n";
			if (request.responseJSON != null) {
				msg += "Message" +
				request.responseJSON.Message + "\n";
			}
		  alert(msg);
		}

		$(document).ready(function () {
			productList();
		});

        //Retrieve product ID from the data-id attribute stored in edit button
		function productGet(ctl) {
		    // Get product id from data- attribute
		    var id = $(ctl).data("id");

		    // Store product id in hidden field
		    $("#productid").val(id);

		    // Call Web API to get a list of Products
		    $.ajax({
		        //the product ID is included on the URL line
		        url: "/api/Product/get" + id + ".json",
		        type: 'GET',
		        dataType: 'json',
		        //If the Get method succeeds in returning a product object, call a function named productAddToFields and pass in the product object
		        success: function (product) {
		            productToFields(product);
		            // Change Update Button Text from "Add" to "Update". This text value is used when ready to add or update data
		            $("#updateButton").text("Update");
		        },
		        error: function (request, message, error) {
		            handleException(request, message, error);
		        }
		    });

		    //uses jQuery to set the value of each input field with the appropriate property of the product object retrieved from the API call
		    function productToFields(product) {
		        $("#productname").val(product.ProductName);
				var t = product.IntroductionDate.split(" ");
		        $("#introdate").val(t[0]);
		        $("#url").val(product.Url);
		    }
		}

        //submit this JavaScript object(Product) to the Post method in your API
        //Ajax is used to call the Post method in the Web API
		function productAdd(product) {
		    $.ajax({
		        url: "/api/Product",
		        type: 'POST',
		        //the contentType property to specify that you’re passing JSON to the API
		        contentType:
                   "application/json;charset=utf-8",
		        //a data property is added where you take the JavaScript Product object you created and serialize it using the JSON.stringify method
		        data: JSON.stringify(product),
		        //If the call to the Post method is successful, a new product object is returned from the Web API
		        //In the success part of the Ajax call, pass this object to a function called productAddSuccess
		        success: function (product) {
		            productAddSuccess(product);
		        },
		        error: function (request, message, error) {
		            handleException(request, message, error);
		        }
		    });
		}

		function productAddSuccess(product) {
		    //Add the newly created product data to the HTML table
		    productAddRow(product);
		    //clear the input fields so that they’re ready to add a new product
		    formClear();
		}

        //uses jQuery to clear each input field
		function formClear() {
		    $("#productname").val("");
		    $("#introdate").val("");
		    $("#url").val("");
		}

		function productUpdate(product) {
		    $.ajax({
		        url: "/api/Product",
		        //product object is sent via an Ajax call using the verb PUT
		        type: 'PUT',
		        contentType:
                   "application/json;charset=utf-8",
		        data: JSON.stringify(product),
		        //If the update is successful, a function called productUpdateSuccess is called and passed the updated product object
		        success: function (product) {
		            productUpdateSuccess(product);
		        },
		        error: function (request, message, error) {
		            handleException(request, message, error);
		        }
		    });
		}

		function productUpdateSuccess(product) {
		    productUpdateInTable(product);
		}

        //locates the row in the HTML table just updated
        //Once the row is located, a new table row is built using the productBuildTableRow function that you created earlier.
        //This newly created row is inserted immediately after the row of the original data. The original row is then removed from the table
		function productUpdateInTable(product) {
		    // Find Product in <table>
		    var row = $("#productTable button[data-id='" + product.ProductId + "']").parents("tr")[0];
		    // Add changed product to table
		    $(row).after(productBuildTableRow(product));
		    // Remove original product
		    $(row).remove();
		    formClear(); // Clear form fields
		    // Change Update Button Text
		    $("#updateButton").text("Add");
		}

		function productDelete(ctl) {
		    //retrieve the value of the product ID contained in the data-id attribute
		    var id = $(ctl).data("id");
		    $.ajax({
		        url: "/api/Product/" + id,
		        type: 'DELETE',
		        //remove the complete row from the HTML by finding the <tr> tag that contains the current delete button 
		        //and calling the remove() method on that table row
		        success: function (product) {
		            $(ctl).parents("tr").remove();
		        },
		        error: function (request, message, error) {
		            handleException(request, message, error);
		        }
		    });
		}
	</script>	
</body>
</html>
